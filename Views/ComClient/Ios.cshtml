@{
    ViewBag.Title = "Ios";
}

<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>poiComClient</title>

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7/jquery.js"></script> 
    <script src="@(Model.ProxyHost):@(Model.ProxyPort)/Scripts/jquery.signalR-1.1.1.min.js"></script>
    <script src="@(Model.ProxyHost):@(Model.ProxyPort)/signalr/hubs"></script>
 
    <script>
        // wait for the DOM to be loaded 
        $(document).ready(function () {
            $.connection.hub.url = "@(Model.ProxyHost):@(Model.ProxyPort)/signalr/";
            $.connection.hub.qs = {
                'userid': "huan",
                'service': "interactive",
                'sessions' : "dummy",
                'isReconnect':0
            };

            poiProxy = $.connection.poiProxy;

            //bind client protocols
            
            poiProxy.client.interactiveSessionCreated = interactiveSessionCreated;
            poiProxy.client.interactiveSessionJoined = interactiveSessionJoined;
            poiProxy.client.interactiveSessionJoinFailed = interactiveSessionJoinFailed;
            poiProxy.client.interactiveSessionNewUserJoined = interactiveSessionNewUserJoined;
                          
            poiProxy.client.interactiveSessionEnded = interactiveSessionEnded;
            poiProxy.client.interactiveSessionRatedAndEnded = interactiveSessionRatedAndEnded;
            poiProxy.client.interactiveSessionCancelled = interactiveSessionCancelled;
            poiProxy.client.interactiveSessionReraised = interactiveSessionReraised;
                          
            poiProxy.client.clientReconnected = clientReconnected;
            
            poiProxy.client.interactiveSessionSynced = interactiveSessionSynced;

            poiProxy.client.textMsgReceived = textMsgReceived;
            poiProxy.client.imageMsgReceived = imageMsgReceived;
            poiProxy.client.voiceMsgReceived = voiceMsgReceived;
            poiProxy.client.illustrationMsgReceived = illustrationMsgReceived;
            poiProxy.client.msgAckReceived = msgAckReceived;

            /*
            $.connection.hub.reconnected(function(){
                clientReconnected();
            });*/
          
            $.connection.hub.disconnected(function(){
                clientDisconnected();
            });
            $.connection.hub.start().done(function ()
            {
                window.location = "poi:hubStart";
            });
                
        });
        
        function clientDisconnected()
        {
            window.location = "poi:function:clientDisconnected";
        }

        //Connection state change callbacks
        function clientReconnected()
        {
            window.location = "poi:function:clientReconnected";
        }
    
        //Set user id for the underlying communication
        function setUserId(userId)
        {
            poiProxy.state.userId = userId;
        }

        //Message received functions, to be called by the proxy server
        function textMsgReceived(senderId, sessionId, message, timestamp)
        {
            window.location = "poi:function:textMsgReceived?senderId=" + senderId + "&sessionId=" + sessionId + "&message=" + message + "&timestamp=" + timestamp;
        }

        function imageMsgReceived(senderId, sessionId, mediaId, timestamp)
        {
            window.location = "poi:function:imageMsgReceived?senderId=" + senderId + "&sessionId=" + sessionId + "&mediaId=" + mediaId + "&timestamp=" + timestamp;
        }

        function voiceMsgReceived(senderId, sessionId, mediaId, timestamp)
        {
            window.location = "poi:function:voiceMsgReceived?senderId=" + senderId + "&sessionId=" + sessionId + "&mediaId=" + mediaId + "&timestamp=" + timestamp;
        }

        function illustrationMsgReceived(senderId, sessionId, mediaId, timestamp)
        {
            window.location = "poi:function:illustrationMsgReceived?senderId=" + senderId + "&sessionId=" + sessionId + "&mediaId=" + mediaId + "&timestamp=" + timestamp;
        }

        function msgAckReceived(sessionId, timestamp)
        {
            window.location = "poi:function:msgAckReceived?sessionId=" + sessionId + "&timestamp=" + timestamp;
        }

        //Session created and joined functions, to be called by the proxy server
        function interactiveSessionCreated(presId, sessionId, timestamp)
        {
            window.location = "poi:function:sessionCreated?presId=" + presId + "&sessionId=" + sessionId + "&timestamp=" + timestamp;
        }

        function interactiveSessionJoined(sessionId, archive, timestamp)
        {
            window.location = "poi:function:interactiveSessionJoined?sessionId=" + sessionId + "&timestamp=" + timestamp + "&archive=" + archive;
        }

        function interactiveSessionJoinFailed(sessionId)
        {
            window.location = "poi:function:interactiveSessionJoinFailed?sessionId=" + sessionId;
        }

        function interactiveSessionNewUserJoined(userId, sessionId, userInfo, timestamp)
        {
            window.location = "poi:function:interactiveSessionNewUserJoined?userId=" + userId + "&sessionId=" + sessionId + "&timestamp=" + timestamp + "&userInfo=" + userInfo;
        }

        //Message sending functions, to be called by the user interface
        function sendTextMsg(sessionId, message, timestamp)
        {
            poiProxy.server.textMsgReceived(sessionId, message, timestamp);
        }

        function sendImageMsg(sessionId, mediaId, timestamp)
        {
            poiProxy.server.imageMsgReceived(sessionId, mediaId, timestamp);
        }

        function sendVoiceMsg(sessionId, mediaId, timestamp)
        {
            poiProxy.server.voiceMsgReceived(sessionId, mediaId, timestamp);
        }

        function sendIllustrationMsg(sessionId, mediaId, timestamp)
        {
            poiProxy.server.illustrationMsgReceived(sessionId, mediaId, timestamp);
        }

        //Session create and join functions, to be called by the user interface
        function createInteractiveSession(mediaId, desc)
        {
            poiProxy.server.createInteractiveSession(mediaId, desc);
        }

        function joinInteractiveSession(sessionId)
        {
            poiProxy.server.joinInteractiveSession(sessionId);
        }
        function interactiveSessionEnded(sessionId)
        {
            //
            //Add your code to handle session ended by tutor
            window.location = "poi:function:interactiveSessionEnded?sessionId="+sessionId;
        }
        
        function interactiveSessionRatedAndEnded(sessionId, rating)
        {
            window.location = "poi:function:interactiveSessionRatedAndEnded?sessionId="+sessionId+"&rating="+rating;
            //Leave the session
            leaveInteractiveSession(sessionId);
        }

        function interactiveSessionCancelled(sessionId)
        {
            window.location = "poi:function:interactiveSessionCancelled?sessionId=" + sessionId;
            //Leave the session
            leaveInteractiveSession(sessionId);
        }

        function reraiseInteractiveSession(sessionId)
        {
            poiProxy.server.reraiseInteractiveSession(sessionId);
        }

        function interactiveSessionReraised(sessionId, newSessionId)
        {
            window.location = "poi:function:interactiveSessionReraised?sessionId=" + sessionId + "&newSessionId=" + newSessionId;
        }
        
        function rateAndEndInteractiveSession(sessionId, rating)
        {
            //for student 1
            poiProxy.server.rateAndEndInteractiveSession(sessionId, rating);
        }
        
        function endInteractiveSession(sessionId)
        {
            //for teacher 1
            poiProxy.server.endInteractiveSession(sessionId);
        }
    
        function leaveInteractiveSession(sessionId)
        {
            poiProxy.server.leaveInteractiveSession(sessionId);
        }
    
        function syncInteractiveSession(sessionId, timestamp)
        {
            poiProxy.server.syncClientMessageWithSession(sessionId, timestamp);
        }
        
        //Session synced callback
        function interactiveSessionSynced(sessionId, missedEvent)
        {
            eventStr = JSON.stringify(missedEvent);
            window.location = "poi:function:interactiveSessionSynced?sessionId="+sessionId+"&missedEvent="+eventStr;
        }
        function rebuildConnection(userId, sessionList)
        {
            $.connection.hub.qs = {
                'userid': userId,
                'service': "interactive",
                'sessions' : sessionList,
                "isReconnect": 1
            };
        
            $.connection.hub.start();
        }

        function rejoinSessionGroups(sessionList)
        {
            poiProxy.server.rejoinSessionGroups(sessionList);
        }

        function disconnectFromProxy()
        {
            $.connection.hub.stop();
        }

    </script>
</head>
<body>
</body>
</html>

