<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>poiComClient</title>

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7/jquery.js"></script> 
    <script src="http://112.124.14.229:8091/Scripts/jquery.signalR-1.1.1.min.js"></script>
    <script src="http://112.124.14.229:8091/signalr/hubs"></script>
 
    <script>
        // wait for the DOM to be loaded 
        $(document).ready(function () {
            $.connection.hub.url = "http://112.124.14.229:8091/signalr/";
            $.connection.hub.qs = {
                'userid': "huan",
                'service': "interactive",
                'sessions' : "dummy",
                'isReconnect':0
            };

            poiProxy = $.connection.poiProxy;

            //bind client protocols
            
            poiProxy.client.interactiveSessionCreated = interactiveSessionCreated;
            poiProxy.client.interactiveSessionJoined = interactiveSessionJoined;
            poiProxy.client.interactiveSessionJoinFailed = interactiveSessionJoinFailed;
            poiProxy.client.interactiveSessionNewUserJoined = interactiveSessionNewUserJoined;
                          
            poiProxy.client.interactiveSessionEnded = interactiveSessionEnded;
            poiProxy.client.interactiveSessionRatedAndEnded = interactiveSessionRatedAndEnded;
                          
            poiProxy.client.clientReconnected = clientReconnected;
            
            poiProxy.client.interactiveSessionSynced = interactiveSessionSynced;

            poiProxy.client.textMsgReceived = textMsgReceived;
            poiProxy.client.imageMsgReceived = imageMsgReceived;
            poiProxy.client.voiceMsgReceived = voiceMsgReceived;
            poiProxy.client.illustrationMsgReceived = illustrationMsgReceived;

            $.connection.hub.reconnected(function(){
                clientReconnected();
            });
          
            $.connection.hub.disconnected(function(){
                clientDisconnected();
            });
            $.connection.hub.start().done(function ()
            {
                window.location = "poi:hubStart";
            });
                
        });
        
        function clientDisconnected()
        {
            window.location = "poi:function:clientDisconnected";
        }

        //Connection state change callbacks
        function clientReconnected()
        {
            window.location = "poi:function:clientReconnected";
        }
    
        //Set user id for the underlying communication
        function setUserId(userId)
        {
            poiProxy.state.userId = userId;
        }

        //Message received functions, to be called by the proxy server
        function textMsgReceived(senderId, sessionId, message)
        {
            window.location = "poi:function:textMsgReceived?senderId="+senderId+"&sessionId="+sessionId+"&message="+message;
        }

        function imageMsgReceived(senderId, sessionId, mediaId)
        {
            window.location = "poi:function:imageMsgReceived?senderId="+senderId+"&sessionId="+sessionId+"&mediaId="+mediaId;
        }

        function voiceMsgReceived(senderId, sessionId, mediaId)
        {
            window.location = "poi:function:voiceMsgReceived?senderId="+senderId+"&sessionId="+sessionId+"&mediaId="+mediaId;
        }

        function illustrationMsgReceived(senderId, sessionId, mediaId)
        {
            
        }

        //Session created and joined functions, to be called by the proxy server
        function interactiveSessionCreated(presId, sessionId)
        {
            window.location = "poi:function:sessionCreated?presId="+presId+"&sessionId="+sessionId;
        }

        function interactiveSessionJoined(sessionId,archive)
        {
	    var archiveStr = JSON.stringify(archive);
            window.location = "poi:function:interactiveSessionJoined?sessionId="+sessionId+"&archive="+archiveStr;
        }

        function interactiveSessionJoinFailed(sessionId)
        {
            window.location = "poi:function:interactiveSessionJoinFailed?sessionId="+sessionId;
        }

        function interactiveSessionNewUserJoined(userId, sessionId)
        {
            window.location = "poi:function:interactiveSessionNewUserJoined?userId="+userId+"&sessionId="+sessionId;
        }

        //Message sending functions, to be called by the user interface
        function sendTextMsg(sessionId, message)
        {
            poiProxy.server.textMsgReceived(sessionId, message);
        }

        function sendImageMsg(sessionId, mediaId)
        {
            poiProxy.server.imageMsgReceived(sessionId, mediaId);
        }

        function sendVoiceMsg(sessionId, mediaId)
        {
            poiProxy.server.voiceMsgReceived(sessionId, mediaId);
        }

        function sendIllustrationMsg(sessionId, mediaId)
        {
            poiProxy.server.illustrationMsgReceived(sessionId, mediaId);
        }

        //Session create and join functions, to be called by the user interface
        function createInteractiveSession(mediaId, desc)
        {
            poiProxy.server.createInteractiveSession(mediaId, desc);
        }

        function joinInteractiveSession(sessionId)
        {
            poiProxy.server.joinInteractiveSession(sessionId);
        }
        function interactiveSessionEnded(sessionId)
        {
            //
            //Add your code to handle session ended by tutor
            window.location = "poi:function:interactiveSessionEnded?sessionId="+sessionId;
        }
        
        function interactiveSessionRatedAndEnded(sessionId, rating)
        {
            window.location = "poi:function:interactiveSessionRatedAndEnded?sessionId="+sessionId+"&rating="+rating;
            //Leave the session
            leaveInteractiveSession(sessionId);
        }
        
        function rateAndEndInteractiveSession(sessionId, rating)
        {
            //for student 1
            poiProxy.server.rateAndEndInteractiveSession(sessionId, rating);
        }
        
        function endInteractiveSession(sessionId)
        {
            //for teacher 1
            poiProxy.server.endInteractiveSession(sessionId);
        }
    
        function leaveInteractiveSession(sessionId)
        {
            poiProxy.server.leaveInteractiveSession(sessionId);
        }
    
        function syncInteractiveSession(sessionId, eventIndex)
        {
            poiProxy.server.syncClientMessageWithSession(sessionId, eventIndex);
        }
        
        //Session synced callback
        function interactiveSessionSynced(sessionId, missedEvent)
        {
            eventStr = JSON.stringify(missedEvent);
            window.location = "poi:function:interactiveSessionSynced?sessionId="+sessionId+"&missedEvent="+eventStr;
        }
        function rebuildConnection(userId, sessionList)
        {
            $.connection.hub.qs = {
                'userid': userId,
                'service': "interactive",
                'sessions' : sessionList,
                "isReconnect": 1
            };
        
            $.connection.hub.start();
        }

    </script>
</head>
<body>
    
</body>
</html>
